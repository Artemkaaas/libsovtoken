ANDROID_BUILD_DIR := _build_android
ANDROID_PREBUILT_DIR=$(ANDROID_BUILD_DIR)/prebuilt
ANDROID_PREBUILT_DEPS_DIR=$(ANDROID_BUILD_DIR)/indy-android-dependencies

LIBINDY_DEPS_FILE := $(PROJECT_DIR)/libsovtoken/build_scripts/android/libindy.dependencies.txt
LIBSOVTOKEN_DEPS_FILE := $(PROJECT_DIR)/libsovtoken/build_scripts/android/libsovtoken/libsovtoken.dependencies.txt

get_android_dependency = $(call check_non_empty,$(shell sed -n -e '/^$(1)_.\+/bx' -e 'd' -e ':x' -e 'p' -e 'q' $(2)),"$(1) is not found in $(2)")

OPENSSL_DEP_FNAME := $(call get_android_dependency,openssl,$(LIBINDY_DEPS_FILE))
SODIUM_DEP_FNAME := $(call get_android_dependency,sodium,$(LIBINDY_DEPS_FILE))
LIBINDY_DEP_FNAME := $(call get_android_dependency,libindy,$(LIBSOVTOKEN_DEPS_FILE))

DEPS = $(ANDROID_PREBUILT_DIR)/$(OPENSSL_DEP_FNAME)

$(DEPS): | $(ANDROID_PREBUILT_DIR)
	wget --no-check-certificate https://10.2.3.179/filely/android/$(@F) -O $@

#    unzip -o -qq ${_FILEY_NAME}
#    rm -f ${_FILEY_NAME}


testme: $(ANDROID_PREBUILT_DIR)/$(OPENSSL_DEP_FNAME)
	ls

# TODO what about multi-staged builds
docker_parent_parts = $(shell sed -n -e 's/FROM[[:space:]]\+\($(if $(2),$(subst /,\/,$(2)),[^[:space:]]\+)\):\([^[:space:]]\+\)/\1 \2/p' -e 'q' $(1))


ANDROID_ARCHS ?= arm armv7 arm64 x86 x86_64

.PHONY: $(ANDROID_PREBUILT_DEPS_DIR)_pull

$(ANDROID_BUILD_DIR) $(ANDROID_PREBUILT_DIR):
	mkdir -p $@

$(ANDROID_PREBUILT_DEPS_DIR): | $(ANDROID_PREBUILT_DIR)
	cd $(ANDROID_PREBUILT_DIR) && git clone --depth 1 https://github.com/evernym/indy-android-dependencies.git

# TODO activate pulling changes if needed
#$(ANDROID_PREBUILT_DEPS_DIR)_pull: | $(ANDROID_PREBUILT_DEPS_DIR)
#	git --git-dir $(ANDROID_PREBUILT_DEPS_DIR)/.git --work-tree $(ANDROID_PREBUILT_DEPS_DIR) pull --depth 1

$(ANDROID_PREBUILT_DIR)/%.zip: $(ANDROID_PREBUILT_DEPS_DIR)/prebuilt/%.zip
	mkdir -p $(@D)
	$(CP) $(ANDROID_PREBUILT_DEPS_DIR)/prebuilt/$*.zip $(@D)/$(*F).zip

$(ANDROID_PREBUILT_DIR)/%/libindy.so $(ANDROID_PREBUILT_DIR)/%/libindy.a: image_lst_libindy_android




.PRECIOUS: $(ANDROID_PREBUILT_DIR)/%.zip $(ANDROID_PREBUILT_DIR)/%/libindy.so $(ANDROID_PREBUILT_DIR)/%/libindy.a
prebuilt_%: $(ANDROID_PREBUILT_DIR)/openssl/openssl_%.zip \
			$(ANDROID_PREBUILT_DIR)/sodium/libsodium_%.zip \
			$(ANDROID_PREBUILT_DIR)/zmq/libzmq_%.zip ;
#	\
#			$(ANDROID_PREBUILT_DIR)/%/libindy.so \
#			$(ANDROID_PREBUILT_DIR)/%/libindy.a ;

build_android: $(patsubst %,prebuilt_%,$(ANDROID_ARCHS)) 
